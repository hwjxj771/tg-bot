const TelegramBot = require('node-telegram-bot-api');
const { Pool } = require('pg');

// Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°
const token = process.env.BOT_TOKEN;
const bot = new TelegramBot(token, { polling: true });

const GAME_URL = 'https://t.me/gift_run_bot/tgiftiF12QIDdag';

// ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
const pool = new Pool({
  connectionString: "postgresql://postgres:XxYjmVHUnYwiOGusWfjLCPajPtwVKLkM@postgres.railway.internal:5432/railway",
  ssl: false
});

// Ğ¢Ğ’ĞĞ™ ĞĞ™Ğ”Ğ˜ - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ñ‹ Ğ¸Ğ¼ĞµĞµÑˆÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Ğ¼
const ADMIN_IDS = [7002066167];

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
function isAdmin(chatId) {
  return ADMIN_IDS.includes(chatId);
}

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
async function initDatabase() {
  try {
    const client = await pool.connect();
    console.log('âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾');
    
    await client.query(`
      CREATE TABLE IF NOT EXISTS users (
        chat_id BIGINT PRIMARY KEY,
        username VARCHAR(255),
        first_name VARCHAR(255),
        last_name VARCHAR(255),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);
    console.log('âœ… Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° users Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°');
    client.release();
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', error.message);
  }
}

// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ username
async function addUser(chatId, userInfo = {}) {
  try {
    const { username, first_name, last_name } = userInfo;
    await pool.query(
      `INSERT INTO users (chat_id, username, first_name, last_name) 
       VALUES ($1, $2, $3, $4) 
       ON CONFLICT (chat_id) 
       DO UPDATE SET 
         username = EXCLUDED.username,
         first_name = EXCLUDED.first_name,
         last_name = EXCLUDED.last_name`,
      [chatId, username, first_name, last_name]
    );
    console.log(`âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½: ${username || chatId}`);
    return true;
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:', error.message);
    return false;
  }
}

// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
async function getAllUsers() {
  try {
    const result = await pool.query('SELECT chat_id, username FROM users');
    console.log(`ğŸ“Š ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ² Ğ±Ğ°Ğ·Ğµ: ${result.rows.length}`);
    return result.rows.map(row => ({
      chatId: row.chat_id,
      username: row.username
    }));
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹:', error.message);
    return [];
  }
}

// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
async function getUserCount() {
  try {
    const result = await pool.query('SELECT COUNT(*) as count FROM users');
    return parseInt(result.rows[0].count);
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ÑÑ‡ĞµÑ‚Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹:', error.message);
    return 0;
  }
}

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ
initDatabase();

// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ chatId (Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°)
bot.onText(/\/myid/, async (msg) => {
  const chatId = msg.chat.id;
  
  if (!isAdmin(chatId)) {
    return bot.sendMessage(chatId, 'âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹.');
  }
  
  const userCount = await getUserCount();
  bot.sendMessage(chatId, `ğŸ“Š Ğ’Ğ°Ñˆ chatId: ${chatId}\nğŸ‘¥ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ² Ğ±Ğ°Ğ·Ğµ: ${userCount}`);
  console.log(`ĞĞ´Ğ¼Ğ¸Ğ½ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ğ» ID: ${chatId}`);
});

// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°)
bot.onText(/\/checkdb/, async (msg) => {
  const chatId = msg.chat.id;
  
  if (!isAdmin(chatId)) {
    return bot.sendMessage(chatId, 'âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹.');
  }
  
  try {
    const userCount = await getUserCount();
    const allUsers = await getAllUsers();
    
    let userList = 'ğŸ“‹ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹:\n\n';
    allUsers.forEach((user, index) => {
      userList += `${index + 1}. @${user.username || 'Ğ±ĞµĞ· username'} (${user.chatId})\n`;
    });
    
    bot.sendMessage(chatId, `âœ… Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚\nğŸ‘¥ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: ${userCount}\n\n${userList}`);
  } catch (error) {
    bot.sendMessage(chatId, `âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±Ğ°Ğ·Ñ‹: ${error.message}`);
  }
});

// ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start (Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ²ÑĞµĞ¼)
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const userInfo = msg.from;
  
  console.log(`ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: ${userInfo.username || 'Ğ±ĞµĞ· username'} (${chatId})`);
  
  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ±Ğ°Ğ·Ñƒ Ñ username
  await addUser(chatId, userInfo);
  const userCount = await getUserCount();
  
  console.log(`Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: ${userCount}`);
  
  // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
  const keyboard = {
    inline_keyboard: [[
      {
        text: 'Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ ğŸš€',
        url: GAME_URL
      }
    ]]
  };
  
  // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ¾Ñ‚ĞºÑƒ Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹
  bot.sendPhoto(chatId, 'https://raw.githubusercontent.com/hwjxj771/tg-bot/main/bot4.png', {
    caption: 'ĞšĞ»Ğ¸ĞºĞµÑ€! ĞšĞµĞ¹ÑÑ‹! CRUSH MODE! Ğ˜ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñ‹!ğŸ’« ĞšĞ°Ğ½Ğ°Ğ» Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ Ğ¸ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹ Ğ¸Ğ³Ñ€Ñ‹ - @gift_run',
    reply_markup: keyboard
  });
});

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ¹ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸
async function sendBroadcastMessage() {
  const message = 'Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¹ ĞºĞµĞ¹Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ - Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°Ğ¹ Ğ¸ Ğ·Ğ°Ğ±Ğ¸Ñ€Ğ°Ğ¹ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñƒ ğŸ”¥';
  
  const keyboard = {
    inline_keyboard: [[
      {
        text: 'Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñƒ ğŸ',
        url: GAME_URL
      }
    ]]
  };
  
  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹
  const allUsers = await getAllUsers();
  
  if (allUsers.length === 0) {
    console.log('âŒ ĞĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸');
    return { successCount: 0, errorCount: 0, totalUsers: 0 };
  }
  
  console.log(`ğŸ“¨ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ Ğ´Ğ»Ñ ${allUsers.length} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹...`);
  
  let successCount = 0;
  let errorCount = 0;
  
  for (const user of allUsers) {
    try {
      await bot.sendMessage(user.chatId, message, {
        reply_markup: keyboard
      });
      successCount++;
      console.log(`âœ… ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: @${user.username || user.chatId}`);
      
      // Ğ—Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ°
      await new Promise(resolve => setTimeout(resolve, 100));
      
    } catch (error) {
      console.error(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ @${user.username || user.chatId}:`, error.message);
      errorCount++;
    }
  }
  
  console.log(`âœ… Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°! Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾: ${successCount}, ĞÑˆĞ¸Ğ±Ğ¾Ğº: ${errorCount}`);
  return { successCount, errorCount, totalUsers: allUsers.length };
}

// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ (Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°)
bot.onText(/\/broadcast/, async (msg) => {
  const chatId = msg.chat.id;
  
  if (!isAdmin(chatId)) {
    return bot.sendMessage(chatId, 'âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹.');
  }
  
  console.log(`Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼: ${chatId}`);
  
  const processingMsg = await bot.sendMessage(chatId, 'ğŸ”„ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ Ğ²ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼...');
  
  const result = await sendBroadcastMessage();
  
  await bot.editMessageText(
    `âœ… Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!\n\nğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹:\nâ€¢ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: ${result.totalUsers}\nâ€¢ Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: ${result.successCount}\nâ€¢ ĞÑˆĞ¸Ğ±Ğ¾Ğº: ${result.errorCount}`,
    {
      chat_id: chatId,
      message_id: processingMsg.message_id
    }
  );
});

// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ (Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°)
bot.onText(/\/stats/, async (msg) => {
  const chatId = msg.chat.id;
  
  if (!isAdmin(chatId)) {
    return bot.sendMessage(chatId, 'âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹.');
  }
  
  const userCount = await getUserCount();
  bot.sendMessage(chatId, `ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ±Ğ¾Ñ‚Ğ°:\n\nğŸ‘¥ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: ${userCount}\nğŸ†” Ğ’Ğ°Ñˆ ID: ${chatId}`);
});

console.log('ğŸ¤– Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ¸ Ğ¶Ğ´ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ...');
console.log('ğŸ‘‘ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€:', ADMIN_IDS[0]);